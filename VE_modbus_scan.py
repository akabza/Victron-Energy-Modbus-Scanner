#!/usr/bin/python3
# -*- coding: utf-8 -*-

# VE_show_modbus_regs.py
# created by Alexander Kabza, 2022-02-25 based on VE_controlspy
#
# show all Modbus registers from Victron Energy Device
#
# 2022-02-25    first version
# 2022-02-26    minor mods

from pymodbus.constants import Defaults
from pymodbus.constants import Endian
from pymodbus.client.sync import ModbusTcpClient as ModbusClient
from pymodbus.payload import BinaryPayloadDecoder
from datetime import datetime
import sys


# --- main -------------------------------------------
if __name__ == "__main__":

    # Instance #'s from Cerbo GX and cross referenced to the unit ID in the Victron TCP-MODbus register xls file Tab #2.
    # https://github.com/victronenergy/dbus_modbustcp/blob/master/CCGX-Modbus-TCP-register-list.xlsx

    addresslist = [800, 806, 807, 808, 809, 810, 811, 812, 813, 814, 815, 816, 817, 818, 819, 820, 821, 822, 823, 824, 825,
               826, 840, 841, 842, 843, 844, 845, 846, 850, 851, 855, 860, 865, 866, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12,
               13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38,
               39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64,
               65, 66, 67, 68, 69, 70, 71, 72, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272,
               273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293,
               294, 295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 312, 314, 316, 318,
               319, 320, 321, 322, 323, 324, 325, 326, 771, 772, 773, 774, 775, 776, 778, 779, 780, 781, 782, 783, 784,
               785, 786, 787, 788, 789, 790, 791, 3700, 3701, 3702, 3703, 3708, 3709, 3710, 3711, 3712, 3713, 3714,
               3715, 3716, 3717, 3718, 3719, 3720, 3721, 3722, 3723, 3725, 3725, 3726, 3727, 1026, 1027, 1028, 1029,
               1030, 1031, 1032, 1033, 1034, 1035, 1036, 1037, 1038, 1039, 1046, 1048, 1050, 1052, 1054, 1056, 1282,
               1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1291, 1292, 1293, 1294, 1295, 1296, 1297, 1298, 1299,
               1300, 1301, 2048, 2049, 2050, 2051, 2052, 2053, 2307, 2308, 2309, 2310, 2311, 2312, 2313, 2314, 2315,
               2316, 2317, 2318, 2319, 2320, 2321, 2322, 2600, 2601, 2602, 2603, 2604, 2605, 2606, 2607, 2608, 2609,
               2616, 2617, 2618, 2619, 2620, 2621, 2622, 2624, 2626, 2628, 2630, 2632, 2634, 2636, 2700, 2701, 2702,
               2703, 2704, 2705, 2706, 2707, 2708, 2709, 2710, 2800, 2802, 2804, 2805, 2806, 2807, 2808, 2900, 2901,
               2902, 2903, 3000, 3001, 3003, 3004, 3005, 3007, 3100, 3101, 3102, 3105, 3106, 3110, 3111, 3112, 3113,
               3114, 3115, 3116, 3117, 3125, 3126, 3127, 3128, 3130, 3132, 3134, 3136, 3138, 3140, 3141, 3142, 3143,
               3148, 3149, 3150, 3151, 3152, 3153, 3154, 3155, 3156, 3157, 3158, 3159, 3160, 3161, 3162, 3163, 3164,
               3165, 3166, 3167, 3200, 3201, 3202, 3203, 3204, 3205, 3206, 3207, 3208, 3209, 3210, 3211, 3212, 3213,
               3214, 3215, 3216, 3217, 3218, 3219, 3220, 3221, 3222, 3223, 3300, 3301, 3302, 3303, 3304, 3305, 3400,
               3402, 3420, 3422, 3423, 3424, 3500, 3501, 3502, 3504, 3506, 3507, 3508, 3600, 3601, 3602, 3603, 3800,
               3802, 3804, 3810, 3814, 3815, 3816, 3818, 3819, 3820, 3821, 3822, 3823, 3824, 3825, 3826, 3900, 3901,
               3902, 3902, 3910, 3911, 3912, 3913, 3914, 3915, 3916, 3918, 3920, 4000, 4001, 4002, 4003, 4004, 4006,
               4007, 4008, 4009, 4010, 4011, 4100, 4101, 4102, 4103, 4104, 4106, 4107, 4108, 4109, 4110, 4111, 4200,
               4201, 4202, 4203, 4204, 4206, 4207, 4208, 4209, 4210, 4211, 4300, 4301, 4302, 4303, 4304, 4306, 4307,
               4308, 4309, 4310, 4311, 4400, 4401, 4402, 4403, 4404, 4406, 4408, 4409, 4410, 4411, 4412, 4413, 4500,
               4501, 4502, 4503, 4504, 4505, 4506, 4507, 4508, 4509, 4510, 4511, 4512, 4513, 4514, 4515, 4516, 4517,
               4518, 4519, 4520, 4521, 4522, 4523, 4524, 4525, 4526, 4527, 4528, 4529, 4530, 4531, 4532, 4533, 4534,
               4535, 4536, 4537, 4538, 4539, 4540, 4541, 4542, 4543, 4544, 4545, 4546, 4548, 4550, 4552, 4554, 4556,
               4558, 4560, 4562, 4564, 4566, 4568, 4570, 4572]

    ip = "192.168.144.106"  # ip address of GX device or if on venus local try localhost

    Defaults.Timeout = 25
    Defaults.Retries = 5

    # Local network ip address of Cerbo GX. Default port 502
    client = ModbusClient(ip, port='502')

        
    for unitID in range (0, 256):
        print("Registers for UnitID {0:d}".format(unitID))
        for address in addresslist:
            try:
                result = client.read_holding_registers(address, 1, unit=unitID)
                decoder = BinaryPayloadDecoder.fromRegisters(result.registers, byteorder=Endian.Big)
                r1 = decoder.decode_16bit_uint()
                print("{0:d} - {1:d}".format(address, r1))
    
            except KeyboardInterrupt:
                print(colors.reset)
                print('\033[?25h', end="")  # Restore Blinking Cursor
                sys.exit(0)
            except AttributeError:
                continue
